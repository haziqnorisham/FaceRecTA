<head>
  <br>
  <br>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <style>
    hr.style {
    	background-color: #fff;
    	border-top: 2px dashed #8c8b8b;
    }

    hr.style2 {
    	background-color: #f7f7f7;
    }

    .csb img {
      height: 120px;
    }
  </style>
</head>
<body>

  <div class="container text-center csb">
    <img src="https://i.ibb.co/Jch15z5/cbs.png" class="img-responsive" alt="Responsive image" border="0">
    <h2>Time attendence system</h2>
  </div>
  <div class="container">
    <hr class="style"/>
  </div>

  <div class="container">
  <div class="container">
    <div class="row">


   <div class="col-sm text-center">
    <form action="/time_attendance/btnAction/">
      <div class="row text-center">
        Choose date to query :
        <br>
      </div>

      <div class="row">
        <div class="col-sm text-right">
            From :
        </div>
        <div class="col-sm">
          <input type="date" name="date" onload="date_value()" id="date_input">
        </div>
      </div>

      <div class="row">
        <div class="col-sm text-right">
          To :
        </div>

        <div class="col-sm">
          <input type="date" name="date2"  id="date_input2">
         </div>
      </div>
    <input type="submit" >
    </form>

    <sup><font color = "red"><i>Click submit after changin the date.</i></font></sup>
    </div>




 <div class="col-sm text-center">

    Minumum Hours Worked :
    <input type="number" name="quantity" min="1" max="12" id="hour_input" value=8 onchange="myFunction()">



    </div>


<div class="col-sm text-center">

        Shift Start Time :
        <br>
        <input type="time" name="usr_time" id="time_input" value="08:00" onchange="checkTime()">




</div>
  <div class="col-sm text-center">
    Employee name :
    <br>
        <select name="Employee" id="name_filter" onchange="name_selector()" >
          <option value="all">All</option>
          {% for dat in data %}
          <option value={{ dat.name }}>{{ dat.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <hr class="style2"/>


    <div class="row">
      <div class="col-sm text-center">
        <h5>Displaying for : <b><i><font color="red">{{ date_tag.date }}</font></i></b> To </h5>
      </div>
    </div>

<hr class="style2"/>
    </div>

    <div class="row">
      <div class="col-sm">  </div>
      <div class="col-sm text-center">
        <button type="button" id="reset_btn" onclick="myFunction2()" class="btn btn-dark">Reset</button>
        <button type="button" id="show_btn" onclick="printDiv()" class="btn btn-dark">Print</button>
      </div>
      <div class="col-sm">  </div>

    </div>
    </div>
    <div class="container">
    <hr class="style"/>
    </div>

    <div class="container">


    <table class="table" id="timeTable">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Employee ID</th>
          <th scope="col">Name</th>
          <th scope="col">Enter Time</th>
          <th scope="col">Enter Location</th>
          <th scope="col">Exit Time</th>
          <th scope="col">Exit Location</th>
          <th scope="col">Working Hours</th>
          <th scope="col">Lateness<br>(Hour:Minuite)</th>
        </tr>
      </thead>
      <tbody>
        {% for dat in data %}
        <tr>
          <th scope="row">{{ dat.id }}</th>
          <td>{{ dat.employee_id }}</td>
          <td>{{ dat.name }}</td>
          <td>{{ dat.capture_time_earliest }}</td>
          <td>{{ dat.capture_location_earliest }}</td>
          <td>{{ dat.capture_time_latest }}</td>
          <td>{{ dat.capture_location_latest }}</td>
          <td>{{ dat.working_hours }}</td>
          <td>-</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <iframe name="print_frame" width="0" height="0" frameborder="0" src="about:blank"></iframe>
  </div>

<script>
function myFunction(){

  table = document.getElementById("timeTable");
  input = document.getElementById("hour_input");
  number_of_rows = table.getElementsByTagName("tr").length;

  var i;
  for (i = 0; i < number_of_rows-1 ; i++) {
    table.rows[i+1].cells[7].style.color = "";
    table.rows[i+1].cells[7].style.fontWeight = "";
  }

  for (i = 0; i < number_of_rows-1 ; i++) {
    temp_hours_worked = table.rows[i+1].cells[7].innerHTML;
    temp_hours_worked = temp_hours_worked.replace(':','');
    temp_hours_worked = temp_hours_worked.replace(':','');

    if(temp_hours_worked < (input.value * 10000)){
      table.rows[i+1].cells[7].style.color = "red";
      table.rows[i+1].cells[7].style.fontWeight = "900";
    }

  }

}

function myFunction2(){
  table = document.getElementById("timeTable");
  input = document.getElementById("hour_input");
  number_of_rows = table.getElementsByTagName("tr").length;

  var i;
  for (i = 0; i < number_of_rows-1 ; i++) {
    table.rows[i+1].cells[7].style.color = "";
    table.rows[i+1].cells[7].style.fontWeight = "";

    table.rows[i+1].cells[3].style.color = "";
    table.rows[i+1].cells[3].style.fontWeight = "";

    table.rows[i+1].style.display = '';

    table.rows[i+1].cells[8].innerHTML = "-";
    table.rows[i+1].cells[8].style.fontWeight = "";
    table.rows[i+1].cells[8].style.color = "";
  }
}

function checkTime(){
  time_input = document.getElementById("time_input")
  table = document.getElementById("timeTable");
  number_of_rows = table.getElementsByTagName("tr").length;

  for (i = 0; i < number_of_rows-1 ; i++) {
      table.rows[i+1].cells[3].style.color = "";
      table.rows[i+1].cells[3].style.fontWeight = "";
      table.rows[i+1].cells[8].innerHTML = "-";
      table.rows[i+1].cells[8].style.fontWeight = "";
      table.rows[i+1].cells[8].style.color = "";
    }

  var i;
  for (i = 0; i < number_of_rows-1 ; i++) {
    temp_enter_time = table.rows[i+1].cells[3].innerHTML;
    temp_enter_time = temp_enter_time.substring(11, 16);


    if(temp_enter_time > time_input.value){
      table.rows[i+1].cells[3].style.color = "red";
      table.rows[i+1].cells[3].style.fontWeight = "900";



      d1 = Date.parse(table.rows[i+1].cells[3].innerHTML);
      d1 = new Date(d1);
      d2 = Date.parse(table.rows[i+1].cells[3].innerHTML);
      d2 = new Date(d2);
      d2.setHours(time_input.value.substring(0,2));
      d2.setMinutes(time_input.value.substring(3,5));

      d3 = d1-d2;

      console.log(d3);

      table.rows[i+1].cells[8].innerHTML = msToTime(d3)

      table.rows[i+1].cells[8].style.fontWeight = "900";
      table.rows[i+1].cells[8].style.color = "red";
    }
  }
}

function msToTime(duration) {
    var milliseconds = parseInt((duration%1000)/100)
        , seconds = parseInt((duration/1000)%60)
        , minutes = parseInt((duration/(1000*60))%60)
        , hours = parseInt((duration/(1000*60*60))%24);

    hours = (hours < 10) ? "0" + hours : hours;
    minutes = (minutes < 10) ? "0" + minutes : minutes;
    seconds = (seconds < 10) ? "0" + seconds : seconds;

    //return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
    return hours + ":" + minutes;
}

function printDiv(){
  window.print()
}

function date_value(){

  table = document.getElementById("timeTable");
  temp_enter_time2 = table.rows[1].cells[3].innerHTML;
  temp_enter_time2 = temp_enter_time2.substring(0, 10);


  var today = new Date();
  var dd = String(today.getDate()).padStart(2, '0');
  var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  var yyyy = today.getFullYear();


  console.log(temp_enter_time2)
  today = temp_enter_time2

  date_input = document.getElementById("date_input")

  date_input.value = today
}

function name_selector(){

  var arr = [];

  filter_value = document.getElementById("name_filter")
  table = document.getElementById("timeTable");
  number_of_rows = table.getElementsByTagName("tr").length;

  var i;
  var j = 0;


  for (i = 0; i < number_of_rows-1 ; i++) {
    table.rows[i+1].style.display = '';
  }

  for (i = 0; i < number_of_rows-1 ; i++) {

    temp_name = table.rows[i+1].cells[2].innerHTML;
    selector_name = filter_value.value;

    if(temp_name == selector_name){
      arr[j] = i+1;
      j++;
      continue;
    }
    else if(selector_name == "all"){
      table.rows[i+1].style.display = '';
    }
    else{
      table.rows[i+1].style.display = 'none';
    }
  }

}

window.onload = date_value;
</script>

</body>
<br>
<!-- Footer -->
<footer class="page-footer">

  <!-- Copyright -->
  <div class="footer-copyright text-center py-1">Â© 2019 Copyright:
    <a href="https://www.camartcctv.com"> camartcctv.com</a>
  </div>
  <!-- Copyright -->

</footer>
